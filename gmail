import thread
import threading
import socket
from selenium import webdriver
import sys,os,time

os.system("clear||cls")
browser_opts = webdriver.ChromeOptions()
def addopt(opt): browser_opts.add_argument(str(opt))
#print(sys.argv[0])
addopt("--incognito"); addopt("--mute-audio");
if os.path.exists("/Applications/Chromium.app/Contents/MacOS/Chromium"):
    browser_opts.binary_location = "/Applications/Chromium.app/Contents/MacOS/Chromium"
elif os.path.exists("/usr/bin/chromium"):
    browser_opts.binary_location = "/usr/bin/chromium"
else:
    while True:
        bin_path = raw_input("Please Enter Chrome/Chromium Executable Path: ")
        if os.path.exists(bin_path):
            browser_opts.binary_location = bin_path
            break
        else:
            print("\nNot A Valid Path\n")
            continue

if os.path.exists(os.getcwd()+"/Drivers/chromedriver"):
    driver_path = str(os.getcwd()+"/Drivers/chromedriver")
elif os.path.exists(sys.argv[0]+"/../Drivers/chromedriver"):
    driver_path = str(sys.argv[0]+"/../Drivers/chromedriver")
else:
    while True:
        driver_path = raw_input("Driver Path: ")
        if os.path.exists(driver_path):
            driver_path = driver_path
            break
        else:
            print("\nNot Valid Path\n")
            continue

driver = webdriver.Chrome(driver_path, chrome_options=browser_opts)

print("All Setup!")

def log(msg): print("\033[01;37m[\033[01;90m%s\033[01;37m] %s"%(time.ctime(),str(msg)))

clients = []
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

def receive_urls(conn):
    while True:
        rurl = conn.recv(65535); url = str(rurl)
        if len(url) < 12:
            conn.send("Valid URL Needed Please!\n")
            log("Valid URL Needed Please!");
            continue
        elif url[:4] != "http" or "://" not in url[:9]:
            conn.send("Not Valid http/https URL!\n")
            log("Not Valid http/https URL!")
        log("RECEIVED URL: %s"%url[:len(url)-1])
        driver.get(url)
def listen_for_connections():
    while True:
        try:
            conn,addr = s.accept()
            log("New Connection From %s"%str(addr[0]))
            clients.append(conn)
            thread.start_new_thread(receive_urls, (conn,))
        except socket.error as error:
            print(error)
        except KeyboardInterrupt:
            os.system("pkill -9 Python && pkill -9 python && pkill -9 Chromium")
            sys.exit(0)

if __name__ == '__main__':
    s.bind((socket.gethostbyname(socket.gethostname()), 2907))
    s.listen(10)
    tlisten = threading.Thread(target=listen_for_connections); tlisten.start()
    #ulisten = threading.Thread(target=receive_urls); ulisten.start()
